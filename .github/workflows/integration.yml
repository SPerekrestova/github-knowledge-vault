name: Integration Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  integration:
    name: Full Stack Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: mcp-bridge/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Python dependencies
        working-directory: mcp-bridge
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node.js dependencies
        run: npm ci

      - name: Create mock MCP Server
        run: |
          mkdir -p /tmp/mock_mcp_server
          cat > /tmp/mock_mcp_server/main.py << 'EOF'
          #!/usr/bin/env python3
          """Mock MCP Server for integration testing"""
          import asyncio
          import json
          from typing import Any, Dict, List
          from mcp.server import Server
          from mcp.server.stdio import stdio_server
          from mcp.types import Tool, TextContent

          app = Server("mock-github-server")

          @app.list_tools()
          async def list_tools() -> List[Tool]:
              return [
                  Tool(name="get_org_repos", description="Get repos", inputSchema={"type": "object", "properties": {"org": {"type": "string"}}, "required": ["org"]}),
                  Tool(name="get_repo_docs", description="Get docs", inputSchema={"type": "object", "properties": {"org": {"type": "string"}, "repo": {"type": "string"}}, "required": ["org", "repo"]}),
                  Tool(name="get_file_content", description="Get content", inputSchema={"type": "object", "properties": {"org": {"type": "string"}, "repo": {"type": "string"}, "path": {"type": "string"}}, "required": ["org", "repo", "path"]}),
                  Tool(name="search_documentation", description="Search", inputSchema={"type": "object", "properties": {"org": {"type": "string"}, "query": {"type": "string"}}, "required": ["org", "query"]})
              ]

          @app.call_tool()
          async def call_tool(name: str, arguments: Dict[str, Any]) -> List[TextContent]:
              if name == "get_org_repos":
                  return [TextContent(type="text", text=json.dumps([{"id": "1", "name": "test-repo", "description": "Test", "url": "https://github.com/test/test-repo", "hasDocFolder": True}]))]
              elif name == "get_repo_docs":
                  return [TextContent(type="text", text=json.dumps([{"id": "1", "name": "README.md", "path": "doc/README.md", "type": "markdown", "size": 100, "url": "https://github.com/test/test-repo", "download_url": "https://raw.githubusercontent.com/test/test-repo/main/doc/README.md", "sha": "abc"}]))]
              elif name == "get_file_content":
                  return [TextContent(type="text", text=json.dumps({"name": "README.md", "path": "doc/README.md", "content": "# Test", "sha": "abc"}))]
              elif name == "search_documentation":
                  return [TextContent(type="text", text=json.dumps([{"name": "README.md", "path": "doc/README.md", "repository": "test-repo", "url": "https://github.com/test/test-repo", "sha": "abc"}]))]
              raise ValueError(f"Unknown tool: {name}")

          async def main():
              async with stdio_server() as (read_stream, write_stream):
                  await app.run(read_stream, write_stream, app.create_initialization_options())

          if __name__ == "__main__":
              asyncio.run(main())
          EOF
          chmod +x /tmp/mock_mcp_server/main.py

      - name: Start MCP Bridge
        working-directory: mcp-bridge
        run: |
          export GITHUB_ORGANIZATION=test-org
          export MCP_SERVER_PATH=/tmp/mock_mcp_server/main.py
          export CACHE_ENABLED=true
          export PORT=3001
          python main.py &
          BRIDGE_PID=$!
          echo "BRIDGE_PID=$BRIDGE_PID" >> $GITHUB_ENV

          # Wait for bridge to start
          for i in {1..30}; do
            if curl -s http://localhost:3001/health > /dev/null; then
              echo "✓ MCP Bridge started successfully"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ MCP Bridge failed to start"
              exit 1
            fi
            sleep 1
          done

      - name: Test Bridge Health Endpoint
        run: |
          response=$(curl -s http://localhost:3001/health)
          echo "Health response: $response"

          status=$(echo $response | jq -r '.status')
          if [ "$status" != "ok" ]; then
            echo "✗ Health check failed"
            exit 1
          fi
          echo "✓ Health check passed"

      - name: Test Bridge API Endpoints
        run: |
          # Test get repos
          echo "Testing GET /api/repos..."
          repos=$(curl -s http://localhost:3001/api/repos)
          echo "Repos: $repos"

          repo_count=$(echo $repos | jq 'length')
          if [ "$repo_count" -eq 0 ]; then
            echo "✗ No repositories returned"
            exit 1
          fi
          echo "✓ GET /api/repos works ($repo_count repos)"

          # Test get docs
          echo "Testing GET /api/repos/test-repo/docs..."
          docs=$(curl -s http://localhost:3001/api/repos/test-repo/docs)
          echo "Docs: $docs"
          echo "✓ GET /api/repos/{repo}/docs works"

          # Test search
          echo "Testing POST /api/search..."
          search=$(curl -s -X POST http://localhost:3001/api/search \
            -H "Content-Type: application/json" \
            -d '{"query": "test"}')
          echo "Search results: $search"
          echo "✓ POST /api/search works"

      - name: Test Cache Functionality
        run: |
          # First request (cache miss)
          echo "Testing cache miss..."
          time1_start=$(date +%s%N)
          curl -s http://localhost:3001/api/repos > /dev/null
          time1_end=$(date +%s%N)
          time1=$((($time1_end - $time1_start) / 1000000))

          # Second request (cache hit)
          echo "Testing cache hit..."
          time2_start=$(date +%s%N)
          curl -s http://localhost:3001/api/repos > /dev/null
          time2_end=$(date +%s%N)
          time2=$((($time2_end - $time2_start) / 1000000))

          echo "First request: ${time1}ms"
          echo "Second request: ${time2}ms (should be faster)"
          echo "✓ Cache tested"

          # Clear cache
          echo "Testing cache clear..."
          curl -s -X POST http://localhost:3001/api/cache/clear
          echo "✓ Cache cleared"

      - name: Build Frontend
        run: |
          npm run build
        env:
          VITE_GITHUB_OWNER: test-org
          VITE_GITHUB_OWNER_TYPE: org

      - name: Stop MCP Bridge
        if: always()
        run: |
          if [ ! -z "$BRIDGE_PID" ]; then
            kill $BRIDGE_PID || true
          fi

      - name: Integration Test Summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ MCP Bridge started successfully" >> $GITHUB_STEP_SUMMARY
          echo "✓ Health check passed" >> $GITHUB_STEP_SUMMARY
          echo "✓ API endpoints working" >> $GITHUB_STEP_SUMMARY
          echo "✓ Cache functionality tested" >> $GITHUB_STEP_SUMMARY
          echo "✓ Frontend build successful" >> $GITHUB_STEP_SUMMARY
